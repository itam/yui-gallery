<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/sm-editor/js/extensions/editor-style.js - SmugMug YUI Gallery API docs</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="SmugMug YUI Gallery API docs"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 3.11.0-git</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/DragDrop.html">DragDrop</a></li>
            
                <li><a href="../classes/Editor.html">Editor</a></li>
            
                <li><a href="../classes/Editor.Base.html">Editor.Base</a></li>
            
                <li><a href="../classes/Editor.DOM.html">Editor.DOM</a></li>
            
                <li><a href="../classes/Editor.Keys.html">Editor.Keys</a></li>
            
                <li><a href="../classes/Editor.Link.html">Editor.Link</a></li>
            
                <li><a href="../classes/Editor.Queue.html">Editor.Queue</a></li>
            
                <li><a href="../classes/Editor.Style.html">Editor.Style</a></li>
            
                <li><a href="../classes/Editor.Undo.html">Editor.Undo</a></li>
            
                <li><a href="../classes/IndexedMap.html">IndexedMap</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/Menu.html">Menu</a></li>
            
                <li><a href="../classes/Menu.Base.html">Menu.Base</a></li>
            
                <li><a href="../classes/Menu.Item.html">Menu.Item</a></li>
            
                <li><a href="../classes/Menu.Templates.html">Menu.Templates</a></li>
            
                <li><a href="../classes/Plugin.DragDrop.Reorder.html">Plugin.DragDrop.Reorder</a></li>
            
                <li><a href="../classes/Plugin.FocusManager.html">Plugin.FocusManager</a></li>
            
                <li><a href="../classes/Plugin.Menu.html">Plugin.Menu</a></li>
            
                <li><a href="../classes/Promise.EventNotifier.html">Promise.EventNotifier</a></li>
            
                <li><a href="../classes/Range.html">Range</a></li>
            
                <li><a href="../classes/Selection.html">Selection</a></li>
            
                <li><a href="../classes/TreeView.html">TreeView</a></li>
            
                <li><a href="../classes/TreeView.Sortable.html">TreeView.Sortable</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/dom-form-values.html">dom-form-values</a></li>
            
                <li><a href="../modules/gallery-sm-dragdrop.html">gallery-sm-dragdrop</a></li>
            
                <li><a href="../modules/gallery-sm-dragdrop-reorder.html">gallery-sm-dragdrop-reorder</a></li>
            
                <li><a href="../modules/gallery-sm-editor.html">gallery-sm-editor</a></li>
            
                <li><a href="../modules/gallery-sm-editor-base.html">gallery-sm-editor-base</a></li>
            
                <li><a href="../modules/gallery-sm-editor-dom.html">gallery-sm-editor-dom</a></li>
            
                <li><a href="../modules/gallery-sm-editor-keys.html">gallery-sm-editor-keys</a></li>
            
                <li><a href="../modules/gallery-sm-editor-link.html">gallery-sm-editor-link</a></li>
            
                <li><a href="../modules/gallery-sm-editor-queue.html">gallery-sm-editor-queue</a></li>
            
                <li><a href="../modules/gallery-sm-editor-style.html">gallery-sm-editor-style</a></li>
            
                <li><a href="../modules/gallery-sm-editor-undo.html">gallery-sm-editor-undo</a></li>
            
                <li><a href="../modules/gallery-sm-focusmanager.html">gallery-sm-focusmanager</a></li>
            
                <li><a href="../modules/gallery-sm-indexed-map.html">gallery-sm-indexed-map</a></li>
            
                <li><a href="../modules/gallery-sm-map.html">gallery-sm-map</a></li>
            
                <li><a href="../modules/gallery-sm-menu.html">gallery-sm-menu</a></li>
            
                <li><a href="../modules/gallery-sm-menu-base.html">gallery-sm-menu-base</a></li>
            
                <li><a href="../modules/gallery-sm-menu-item.html">gallery-sm-menu-item</a></li>
            
                <li><a href="../modules/gallery-sm-menu-plugin.html">gallery-sm-menu-plugin</a></li>
            
                <li><a href="../modules/gallery-sm-menu-templates.html">gallery-sm-menu-templates</a></li>
            
                <li><a href="../modules/gallery-sm-promise-events.html">gallery-sm-promise-events</a></li>
            
                <li><a href="../modules/gallery-sm-range.html">gallery-sm-range</a></li>
            
                <li><a href="../modules/gallery-sm-selection.html">gallery-sm-selection</a></li>
            
                <li><a href="../modules/gallery-sm-treeview.html">gallery-sm-treeview</a></li>
            
                <li><a href="../modules/gallery-sm-treeview-sortable.html">gallery-sm-treeview-sortable</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/sm-editor/js/extensions/editor-style.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*jshint expr:true, onevar:false */

/**
Provides the &#x60;Editor.Style&#x60; extension.

@module gallery-sm-editor
@submodule gallery-sm-editor-style
**/

/**
Extension for &#x60;Editor.Base&#x60; that normalizes style commands into css properties

@class Editor.Style
@constructor
@extends Base
@extensionfor Editor.Base
**/

(function() {

var doc = Y.config.doc,
    win = Y.config.win,
    EDOM = Y.Editor.DOM,
    STYLENODE = &#x27;&lt;span&gt;&lt;/span&gt;&#x27;;

var EditorStyle = Y.Base.create(&#x27;editorStyle&#x27;, Y.Base, [], {
    // -- Public Properties ----------------------------------------------------

    /**
    Hash of style commands supported by this editor.

    Names should correspond with valid &#x60;execCommand()&#x60; command names. Values
    are properties in the following format:

    @property {Object} styleCommands
      @param {String} property The name of the CSS property in camelCase form
      @param {String} [valueOn] The &#x60;on&#x60; value of the property. eg. &#x60;bold&#x60;
      @param {String} [valueOff] The &#x60;off&#x60; value of the property. eg. &#x60;none&#x60;
    **/
    styleCommands: {
        bold: {
            property: &#x27;fontWeight&#x27;,
            valueOn: &#x27;bold&#x27;,
            valueOff: &#x27;normal&#x27;
        },

        fontName: {
            property: &#x27;fontFamily&#x27;
        },

        fontSize: {
            property: &#x27;fontSize&#x27;
        },

        italic: {
            property: &#x27;fontStyle&#x27;,
            valueOn: &#x27;italic&#x27;,
            valueOff: &#x27;normal&#x27;
        },

        underline: {
            property: &#x27;textDecoration&#x27;,
            valueOn: &#x27;underline&#x27;,
            valueOff: &#x27;none&#x27;
        }
    },

    /**
    Key commands related to style functionality.

    @property {Object} styleKeyCommands
    **/
    styleKeyCommands: {
        &#x27;backspace&#x27;: {fn: &#x27;_afterDelete&#x27;, allowDefault: true, async: true},
        &#x27;delete&#x27;   : {fn: &#x27;_afterDelete&#x27;, allowDefault: true, async: true}
    },


    // -- Lifecycle ------------------------------------------------------------

    initializer: function () {
        if (this.keyCommands) {
            this.keyCommands = Y.merge(this.keyCommands, this.styleKeyCommands);
        }
    },

    destructor: function () {
    },


    // -- Public Methods -------------------------------------------------------

    /**
    Bolds or unbolds the current selection.

    @method bold
    @chainable
    **/
    bold: function () {
        this.command(&#x27;bold&#x27;, &#x27;toggle&#x27;);
        return this;
    },

    /**
    Italicizes or unitalicizes the current selection.

    @method italic
    @chainable
    **/
    italic: function () {
        this.command(&#x27;italic&#x27;, &#x27;toggle&#x27;);
        return this;
    },

    /**
    Gets and/or sets the values of multiple editor style commands.

    When called without an argument, the current values of all supported style
    commands will be returned. When called with a _styles_ object, the specified
    style commands will be set to their given values, and the resulting new
    values will be returned.

    @method styles
    @param {Object} [styles] Hash of style names and values to set.
    @return {Object} Hash of style names and values that were set, or all styles
        if no _styles_ parameter was specified.
    **/
    styles: function (styles) {
        var results = {},
            name;

        if (styles) {
            for (name in styles) {
                if (styles.hasOwnProperty(name)) {
                    results[name] = this.command(name, styles[name]);
                }
            }
        } else {
            var commands = this.styleCommands;

            for (name in commands) {
                if (commands.hasOwnProperty(name)) {
                    results[name] = this._queryCommandValue(name);
                }
            }
        }

        return results;
    },

    /**
    Toggles underline on the current selection.

    @method underline
    @chainable
    **/
    underline: function () {
        this.command(&#x27;underline&#x27;, &#x27;toggle&#x27;);
        return this;
    },


    // -- Protected Methods ----------------------------------------------------

    /**
    Duckpunch Editor.Base._execCommand to build css styled nodes instead of
    relying on spotty browser compatibility of &#x60;styleWithCSS&#x60;

    Passes through to Editor.Base for any commands not defined
    in &#x60;this.styleCommands&#x60;

    @method _execCommand
    @param {String} name Command name.
    @param {Boolean|String} value Command value.
    @protected
    **/
    _execCommand: function(name, value) {
        var command = this.styleCommands[name],
            range = this.selection.range(),
            styleNodes, style;

        if (!range) {
            return;
        }

        if (!command) {
            return Y.Editor.Base.prototype._execCommand.call(this, name, value);
        }

        styleNodes = this._getStyleNodes(range);

        // These nodes aren&#x27;t in the DOM, getStyle() won&#x27;t work...at least on
        // any windows browser.  works fine on OSX. weird.
        style = styleNodes.item(0)._node.style[command.property];

        if (this.boolCommands[name] &amp;&amp; &#x27;toggle&#x27; === value) {
            if (style &amp;&amp; &#x27;&#x27; !== style) {
                style = &#x27;&#x27;;
            } else {
                style = command.valueOn;
            }
        } else {
            style = value;
        }

        styleNodes.setStyle(command.property, style);

        // expanding the range before deleting contents makes sure
        // the entire node is deleted, if possible.
        range.expand(this._inputNode).deleteContents();

        this._splitAfterRange(range, styleNodes);

        range.startNode(styleNodes.item(0), 0);
        range.endNode(styleNodes.item(styleNodes.size() - 1));
        range.endOffset(EDOM.maxOffset(range.endNode()));

        this.selection.select(range);
    },


    /**
    Reformats html to the proper style

    &lt;span&gt;blah blah&lt;/span&gt;
    @param {HTML} html HTML string to format
    @return {Node} Node instance containing a document fragment with the
        formatted _html_
    @protected
    **/
    _formatHTML: function(html) {
        function flatten(node) {
            var childNodes = node.get(&#x27;childNodes&#x27;)._nodes;

            Y.Array.each(childNodes.reverse(), function(node) {
                var parentNode;

                node = Y.one(node);
                parentNode = node.get(&#x27;parentNode&#x27;);

                if (EDOM.isTextNode(node)) {
                    if (EDOM.isContainer(parentNode)) {
                        node.wrap(STYLENODE);
                    } else if (node.get(&#x27;previousSibling&#x27;)) {
                        EDOM.split(parentNode, node);
                    }
                } else {
                    // TODO: replace b, em, i, strong, u nodes with spans

                    if (!EDOM.isContainer(parentNode)) {
                        parentNode.insert(node, &#x27;after&#x27;);

                        node.addClass(parentNode.get(&#x27;className&#x27;));

                        EDOM.copyStyles(parentNode, node, supportedStyles, {
                            explicit: true,
                            overwrite: false
                        });
                    } else {
                        // TODO: clear styles on containers
                    }

                    flatten(node);

                    if (!EDOM.isContainer(node) &amp;&amp; EDOM.isEmptyNode(node)) {
                        node.remove(true);
                    }

                    node.removeAttribute(&#x27;id&#x27;);
                }
            });
        }

        var frag, supportedStyles = [];

        Y.Object.each(this.styleCommands, function(cmd) {
            supportedStyles.push(cmd.property);
        });

        frag = Y.one(doc.createDocumentFragment()).setHTML(html);

        flatten(frag);

        return frag;
    },


    /**
    Getter for the &#x60;html&#x60; attribute.

    @method _getHTML
    @param {HTML} value HTML.
    @return {HTML} HTML.
    @protected
    **/
    _getHTML: function (value) {
        value = Y.Editor.Base.prototype._getHTML.call(this, value);

        return this.get(&#x27;formatFn&#x27;)(value).getHTML();
    },


    /**
    Walks the ancestor tree of a given node until a node that has
    the css property set is found

    @method _getStyledAncestor
    @param {Node} startNode
    @param {String} property
    @param {Boolean} [self] Whether or not to include &#x60;startNode&#x60; in the scan
    @return {Node} The node having &#x60;property&#x60; set, or null if no node was found
    @protected
    **/
    _getStyledAncestor: function(startNode, property, self) {
        return startNode.ancestor(function(node) {
            if (!EDOM.isElementNode(node)) {
                return false;
            }

            // don&#x27;t use node.getStyle() because it will return
            // computedStyle for empty string values like &#x60;property: &quot;&quot;&#x60;
            // https://github.com/yui/yui3/blob/master/src/dom/js/dom-style.js#L106
            return !!node._node.style[property];
        }, self, this.selectors.input);
    },


    /**
    Parses inline elements from a given range. Partially selected nodes will
    be split and text nodes will be wrapped in &#x60;&lt;span&gt;&#x60; tags if necessary.

    The range will not be modified.

    @method _getStyleNodes
    @param {Range} range
    @return {NodeList} NodeList of inline elements within the given &#x60;range&#x60;
    @protected
    **/
    _getStyleNodes: function(range) {
        var inlineParent, styleContext, contents;

        // expanding the range before deleting contents makes sure
        // the entire node is deleted, if possible.
        range.expand(this._inputNode);

        // see if the range is contained in an inline element
        inlineParent = EDOM.getAncestorElement(
            range.parentNode(),
            EDOM.isInlineElement
        );

        if (inlineParent) {
            if (range.toString() === inlineParent.get(&#x27;text&#x27;)) {
                // the entire node is selected, just return the node
                return new Y.NodeList([inlineParent]);
            }

            // wrap textnodes in clones of the inline parent node
            // to maintain existing styles
            styleContext = inlineParent;
        } else {
            styleContext = Y.Node.create(STYLENODE);
        }

        contents = range.cloneContents().get(&#x27;childNodes&#x27;);

        contents.each(function(node, ix) {
            if (EDOM.isTextNode(node)) {
                // wrap any text nodes in a style context
                contents.splice(ix, 1, styleContext.cloneNode(false).append(node));
            }
        });

        return contents;
    },


    /**
    Setter for the &#x60;html&#x60; attribute.

    @method _setHTML
    @param {HTML} value HTML.
    @return {HTML} HTML.
    @protected
    **/
    _setHTML: function (value) {
        value = this.get(&#x27;formatFn&#x27;)(value).getHTML();

        return Y.Editor.Base.prototype._setHTML.call(this, value);
    },


    /**
    Splits the node at the end of the selection

    @method _splitAfterRange
    @param {Range} range
    @param {HTMLCollection|HTMLElement|Node|NodeList|String} [contents] Contents
        to be inserted after the split
    @return {Node} Node reference of the node created after splitting. Any
        _contents_ will have been inserted as previous siblings of this node.
    **/
    _splitAfterRange: function(range, contents) {
        var endNode, endOffset;

        endNode = range.endNode();
        endOffset = range.endOffset();

        while (!EDOM.isContainer(endNode) &amp;&amp; endOffset === EDOM.maxOffset(endNode)) {
            endOffset = range.endOffset(&#x27;after&#x27;);
            endNode = range.endNode();
        }

        while (!EDOM.isContainer(endNode)) {
            endOffset = EDOM.split(endNode, endOffset);
            endNode = endOffset.get(&#x27;parentNode&#x27;);
        }

        if (contents) {
            endNode.insert(contents, endOffset);
        }

        if (!endOffset._node) {
            endOffset = endNode.get(&#x27;childNodes&#x27;).item(endOffset);
        }

        return endOffset;
    },


    /**
    Duckpunch Editor.Base _queryCommandValue to query the css properties of nodes
    instead of relying on spotty browser compatibility of &#x60;styleWithCSS&#x60;

    Passes through to Editor.Base for any commands not defined
    in &#x60;this.styleCommands&#x60;

    @method _queryCommandValue
    @param {String} name Command name.
    @return {Boolean|String} Command value.
    @protected
    **/
    _queryCommandValue: function(name) {
        var command = this.styleCommands[name],
            range = this.selection.range(),
            parentNode, styleNode, value;

        if (!command) {
            return Y.Editor.Base.prototype._queryCommandValue.call(this, name);
        }

        if (range) {
            parentNode = range.shrink().parentNode();

            // first attempt to get any explicitly styled ancestor for
            // the given property. Need to do this first because browsers
            // sometimes return different values for explicit style vs.
            // computed style. &#x60;font-weight: bold;&#x60; for example will return
            // &#x60;bold&#x60; in all browsers when explicitly set but &#x60;700&#x60; in
            // Firefox and Internet Explorer with computedStyle.
            styleNode = this._getStyledAncestor(parentNode, command.property, true);

            if (!styleNode) {
                // no explicitly styled ancestor found. walk the
                // ancestor tree to find the closest element
                // node ancestor, inclusive of the parentNode
                styleNode = EDOM.getAncestorElement(parentNode);
            }

            // getStyle will fall back to computedStyle if the
            // property isn&#x27;t explicitly set
            value = styleNode.getStyle(command.property);
        }

        if (this.boolCommands[name]) {
            value = (value === command.valueOn);
        } else if (&#x27;&#x27; === value) {
            value = null;
        }

        return value;
    },

    // -- Protected Event Handlers ---------------------------------------------

    /**
    Handles &#x60;delete&#x60; events on the editor

    @method _afterDelete
    @protected
    **/
    _afterDelete: function() {
        this._clearCommandQueue();
        this._updateSelection({force: true});
    },


    /**
    Handles &#x60;paste&#x60; events on the editor.

    @method _onPaste
    @param {EventFacade} e
    @protected
    **/
    _onPaste: function (e) {
        var clipboard = e._event.clipboardData || win.clipboardData,
            contents = clipboard.getData(&#x27;text&#x27;),
            range = this.selection.range();

        e.preventDefault();

        contents = this.get(&#x27;formatFn&#x27;)(contents);

        if (!range.isCollapsed()) {
            // expanding the range before deleting contents makes sure
            // the entire node is deleted, if possible.
            range.expand(this._inputNode);

            range.deleteContents();
        }

        range.endNode(this._splitAfterRange(range, contents), &#x27;before&#x27;);

        // collapse the range after the pasted text
        this.selection.select(range.collapse());
        this._updateSelection({force: true});
    }
}, {
    ATTRS: {
        /**
        Function for formatting editor html

        One day allow custom formatting. Today is not that day.
        **/
        formatFn: {
            readOnly: true,
            setter: function(val) {
                return Y.bind(val, this);
            },
            validator: Y.Lang.isFunction,
            valueFn: function() {
                return this._formatHTML;
            }
        }
    }
});

Y.namespace(&#x27;Editor&#x27;).Style = EditorStyle;

}());

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>

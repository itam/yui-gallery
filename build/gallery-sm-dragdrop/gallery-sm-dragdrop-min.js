YUI.add("gallery-sm-dragdrop",function(e,t){var n=e.DOM,r=e.config.doc,i=e.ClassNameManager.getClassName,s=typeof navigator!="undefined"&&/^mac/i.test(navigator.platform),o=e.config.win,u=o.MutationObserver||o.WebKitMutationObserver||o.MozMutationObserver,a="drag",f="dragend",l="dragenter",c="dragleave",h="dragover",p="dragstart",d="drop",v=e.Base.create("dragdrop",e.Base,[],{classNames:{dragging:i("dragging"),dragover:i("dragover"),droppable:i("droppable")},initializer:function(){this._dragState={},this._publishedEvents={},this._container=this.get("container"),this._distanceThreshold=this.get("distanceThreshold"),this._dragHandleSelector=this.get("dragHandleSelector"),this._dragSelector=this.get("dragSelector"),this._scrollContainer=this.get("scrollContainer"),this._scrollMargin=this.get("scrollMargin"),this._scrollSelector=this.get("scrollSelector"),this._container===e.one("body")&&(this._containerIsBody=!0),this._attachEvents()},destructor:function(){this._endDrag(),this._detachEvents(),this._dragState=null,this._publishedEvents=null},sync:function(){return this._dragState.dragging&&(this._cacheBoundingRects(),(this._scrollContainer||this._scrollSelector)&&this._cacheScrollRects()),this},_attachEvents:function(){this._events&&this._detachEvents();var t=this._container,n=e.one(e.config.doc),r=this._dragSelector;this._events=[this.after(["containerChange","distanceThresholdChange","dragHandleSelectorChange","dragSelectorChange","scrollContainerChange","scrollMarginChange","scrollSelectorChange"],this._cacheAttrValue),this.after(["containerChange","distanceThresholdChange","dragSelectorChange","enableTouchDragChange","timeThresholdChange","useMutationObserverChange"],this._reinitialize),this.after(["dropSelectorChange","scrollContainerChange","scrollSelectorChange"],this.sync),t.delegate("dragstart",this._onNativeDragStart,r,this),t.delegate("gesturemovestart",this._onDraggableMoveStart,r,{},this),n.on("gesturemove",this._onDocMove,{standAlone:!0},this),n.on("gesturemoveend",this._onDocMoveEnd,{standAlone:!0},this)],u&&this.get("useMutationObserver")&&(this._mutationObserver=new u(e.bind(this.sync,this)))},_cacheAttrValue:function(e){this["_"+e.attrName]=e.newVal},_cacheBoundingRects:function(){var t=this._proxyOrDragNode()._node,n=e.Selector.query(this.get("dropSelector"),this._container._node),r=this._dropRects=[],i,s;for(var o=0,u=n.length;o<u;o++)i=n[o],i!==t&&(s=this._getBoundingRect(i),s.el=i,r.push(s));r.sort(function(e,t){return e.top-t.top||e.left-t.left})},_cacheScrollRects:function(){var t=this._scrollRects=[],n=[];this._scrollContainer&&n.push(this._container._node),this._scrollSelector&&Array.prototype.push.apply(n,e.Selector.query(this._scrollSelector,this._container._node));if(!n.length)return t;var r,i,s,o;for(var u=0,a=n.length;u<a;u++){r=n[u],s=r.scrollHeight>r.clientHeight,i=r.scrollWidth>r.clientWidth;if(s||i)o=this._getBoundingRect(r),o.el=r,o.isVertical=s,o.isHorizontal=i,t.push(o)}return t.sort(function(e,t){return e.top-t.top||e.left-t.left}),t},_detachEvents:function(){this._events&&((new e.EventHandle(this._events)).detach(),this._events=null),this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=null)},_endDrag:function(){var t=this._dragState;t.pending?this._endPendingDrag():t.dragging&&(t.dropNode&&this._fireDragLeave(),this._mutationObserver&&this._mutationObserver.disconnect(),this._proxyOrDragNode().removeClass(this.classNames.dragging),this._publishAndFire(f,e.merge(t,{deltaXY:this._getDelta(),state:t}))),this._dragState={},this._dropRects=null,this._scrollIntersections=null,this._scrollRects=null,this._scrollTimeout=clearTimeout(this._scrollTimeout)},_endPendingDrag:function(){this._pendingDragTimeout=clearTimeout(this._pendingDragTimeout),this._restoreTouchCallout()},_findDropIntersection:function(){var e=this._dropRects,t=this._dragState,n=t.dragNode._node,r=t.pageXY[0],i=t.pageXY[1],s;for(var o=0,u=e.length;o<u;o++){s=e[o];if(i<s.top)return null;if(n!==s.el&&i<=s.bottom&&i>=s.top&&r<=s.right&&r>=s.left)return s.el}},_findScrollIntersections:function(){var e=[],t=this._scrollRects;if(!t.length)return e;var n=this._scrollMargin,r=this._dragState,i=r.pageXY[0],s=r.pageXY[1],o,u;for(var a=0,f=t.length;a<f;a++){u=t[a];if(s<u.top)break;s<=u.bottom&&s>=u.top&&i<=u.right&&i>=u.left&&(o={el:u.el},u.isVertical&&(u.bottom-s<=n?o.down=!0:s-u.top<=n&&(o.up=!0)),u.isHorizontal&&(u.right-i<=n?o.right=!0:i-u.left<=n&&(o.left=!0)),(o.down||o.up||o.right||o.left)&&e.push(o))}return e},_fireDrag:function(){var t=this._getDelta(),n=this._dragState;this._publishAndFire(a,e.merge(n,{deltaXY:t,state:n}),{defaultFn:this._defDragFn}),n.dropNode&&this._publishAndFire(h,e.merge(n,{deltaXY:t,state:n}))},_fireDragEnter:function(t){var n=this._dragState;n.preventedDropNode=null,this._publishAndFire(l,e.merge(n,{deltaXY:this._getDelta(),dropNode:t,state:n}),{defaultFn:this._defDragEnterFn,preventedFn:this._preventedDragEnterFn})},_fireDragLeave:function(){var t=this._dragState;this._proxyOrDragNode().removeClass(this.classNames.droppable),t.dropNode.removeClass(this.classNames.dragover),this._publishAndFire(c,e.merge(t,{deltaXY:this._getDelta(),state:t})),t.dropNode=null,t.preventedDropNode=null},_fireDragStart:function(){var t=this._dragState;if(!t.pending)return;this._endPendingDrag(),this._publishAndFire(p,e.merge(t,{state:t}),{defaultFn:this._defDragStartFn,preventedFn:this._preventedDragStartFn})},_getAbsoluteBoundingRect:function(e){var t=r.body,n=o.pageXOffset!==undefined?o.pageXOffset:(r.documentElement||t.parentNode||t).scrollLeft,i=o.pageYOffset!==undefined?o.pageYOffset:(r.documentElement||t.parentNode||t).scrollTop,s=e.getBoundingClientRect();if(e!==t){var u=e.parentNode;while(u!==t)n+=u.scrollLeft,i+=u.scrollTop,u=u.parentNode}return{bottom:s.bottom+i,height:s.height||s.bottom-s.top,left:s.left+n,right:s.right+n,top:s.top+i,width:s.width||s.right-s.left}},_getBoundingRect:function(e){var t=e.getBoundingClientRect();return"width"in t?t:{bottom
:t.bottom,height:t.height||t.bottom-t.top,left:t.left,right:t.right,top:t.top,width:t.width||t.right-t.left}},_getDelta:function(){var e=this._dragState;return[Math.abs(e.startXY[0]-e.pageXY[0]),Math.abs(e.startXY[1]-e.pageXY[1])]},_moveDragNode:function(){var e=this._proxyOrDragNode()._node,t=this._dragState;if(this._containerIsBody)n.setXY(e,[t.pageXY[0]+t.offsetXY[0],t.pageXY[1]+t.offsetXY[1]]);else{var r=this._getAbsoluteBoundingRect(this._container._node),i=this._getBoundingRect(e);n.setXY(e,[Math.max(r.left,Math.min(r.right-i.width,t.pageXY[0]+t.offsetXY[0])),Math.max(r.top,Math.min(r.bottom-i.height,t.pageXY[1]+t.offsetXY[1]))])}},_preventTouchCallout:function(){var e=this._dragState.dragNode,t=e&&e._node;t&&(e.setData("originalTouchCalloutValue",t.style.webkitTouchCallout),t.style.webkitTouchCallout="none")},_proxyOrDragNode:function(){return this._dragState.proxyNode||this._dragState.dragNode},_publishAndFire:function(e,t,n){return n&&n.silent?n.defaultFn&&n.defaultFn.call(this,t):(n&&!this._publishedEvents[e]&&(this._publishedEvents[e]=this.publish(e,n)),this.fire(e,t)),this},_reinitialize:function(){this._endDrag(),this._container===e.one("body")&&(this._containerIsBody=!0),this._detachEvents(),this._attachEvents()},_restoreTouchCallout:function(){var e=this._dragState.dragNode,t=e&&e._node;t&&(t.style.webkitTouchCallout=e.getData("originalTouchCalloutValue")||"default",e.clearData("originalTouchCalloutValue"))},_scroll:function(e){var t=this._scrollIntersections,n=t&&t.length;if(!n)return;var r,i;e||(e=1);for(var s=0;s<n;s++)r=t[s],i=r.el,r.down?i.scrollTop=Math.min(i.scrollHeight,i.scrollTop+e):r.up&&(i.scrollTop=Math.max(0,i.scrollTop-e)),r.right?i.scrollLeft=Math.min(i.scrollWidth,i.scrollLeft+e):r.left&&(i.scrollLeft=Math.max(0,i.scrollLeft-e));this.sync();if(!this._scrollTimeout){var o=this;this._scrollTimeout=setTimeout(function(){o._scrollTimeout=null,o._scroll(e+=1),o._moveDragNode()},20)}},_defDragFn:function(){var t=this._dragState;if(this._scrollContainer||this._scrollSelector)this._scrollIntersections=this._findScrollIntersections(),this._scroll();this._moveDragNode();var n=this._findDropIntersection();if(n){if(t.dropNode){if(n===t.dropNode._node)return;this._fireDragLeave()}else if(t.preventedDropNode&&n===t.preventedDropNode._node)return;this._fireDragEnter(e.one(n))}else t.dropNode&&this._fireDragLeave()},_defDragEnterFn:function(e){this._dragState.dropNode=e.dropNode,this._proxyOrDragNode().addClass(this.classNames.droppable),e.dropNode.addClass(this.classNames.dragover)},_defDragStartFn:function(e){var t=this._dragState,n=t.dragNode.getXY(),r=e.pointerOffset||this.get("pointerOffset");t.dragging=!0,t.pending=!1,r==="auto"?t.offsetXY=[n[0]-t.startXY[0],n[1]-t.startXY[1]]:t.offsetXY=r,t.dragNode.addClass(this.classNames.dragging),this._proxyOrDragNode().addClass(this.classNames.dragging),this.sync(),this._mutationObserver&&this._mutationObserver.observe(this._container._node,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this._fireDrag()},_onDocMove:function(e){var t=this._dragState;if(!t.dragging&&!t.pending)return;t.pageXY=[e.pageX,e.pageY];if(t.dragging)e.preventDefault(),this._fireDrag();else if(t.pending){var n=this._getDelta(),r=this._distanceThreshold;(n[0]>r||n[1]>r)&&this._fireDragStart()}},_onDocMoveEnd:function(t){var n=this._dragState;if(!n.dragging&&!n.pending)return;n.dragging&&(t._event.preventDefault?t._event.preventDefault():t._event.returnValue=!1,t.touches&&(n.dragNode.once("mousedown",function(e){e.preventDefault()}),n.dragNode.once("click",function(e){e.preventDefault()})),n.dropNode&&this._publishAndFire(d,e.merge(n,{deltaXY:this._getDelta(),state:n}))),this._endDrag()},_onDraggableMoveStart:function(e){if(e.button>1||s&&e.ctrlKey)return;if(e.touches&&!this.get("enableTouchDrag"))return;var t=this._dragHandleSelector;if(t&&!e.target.ancestor(t,!0))return;var n=this,r=this._dragState;r.dragging=!1,r.dragNode=e.currentTarget,r.pageXY=[e.pageX,e.pageY],r.pending=!0,r.startXY=[e.pageX,e.pageY],this._preventTouchCallout(),this._pendingDragTimeout=setTimeout(function(){n._fireDragStart()},this.get("timeThreshold"))},_onNativeDragStart:function(e){e.preventDefault()},_preventedDragEnterFn:function(e){e.state.preventedDropNode=e.dropNode},_preventedDragStartFn:function(){this._endDrag()}},{ATTRS:{container:{setter:e.one,valueFn:function(){return e.one("body")}},distanceThreshold:{value:10},dragHandleSelector:{},dragSelector:{},dropSelector:{},enableTouchDrag:{value:!0},pointerOffset:{value:"auto"},scrollContainer:{value:!1},scrollMargin:{value:50},scrollSelector:{},timeThreshold:{value:800},useMutationObserver:{value:!1}}});e.namespace("SM").DragDrop=v},"@VERSION@",{requires:["base","classnamemanager","event-move","node-event-delegate","node-screen"]});
